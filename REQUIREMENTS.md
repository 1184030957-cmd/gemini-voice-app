# Gemini Voice App - 需求规格文档

## 📋 项目概述

| 项目 | 说明 |
|------|------|
| **应用名称** | Gemini Voice App |
| **目标平台** | Android |
| **技术栈** | Flutter 3.13.9 / Dart 3.x |
| **当前版本** | 1.1.0+5 |
| **目标版本** | 2.0.0 |

---

## 🎯 核心功能需求

### F1. 自定义 API 调用
**优先级:** P0 (必须)

**描述:** 用户可以配置自定义的 API 地址、Key 和模型名称

**需求细则:**
- [ ] 支持输入自定义 API 地址（支持 http/https）
- [ ] 支持输入 API Key
- [ ] 支持输入模型名称
- [ ] 配置信息本地安全存储
- [ ] 支持随时修改配置
- [ ] 支持测试 API 连接

### F2. 语音输入 - 持续对话模式
**优先级:** P0 (必须)

**描述:** 实现"像打电话一样"的自然对话体验

**需求细则:**
- [ ] **VAD (Voice Activity Detection):** 自动检测用户开始/停止说话
- [ ] **自动开始监听:** 用户开始说话时自动开始识别
- [ ] **自动停止监听:** 用户停止说话 N 秒后自动停止识别
- [ ] **状态指示器:** 清晰显示"正在听"、"正在识别"、"AI 思考中"、"AI 说话中"
- [ ] **打断支持:** 用户可随时说话打断 AI 回复
- [ ] **静音检测:** 识别到静音后自动触发 API 调用

**交互流程:**
```
1. 用户开始说话 → 自动开始语音识别
2. 用户停止说话 → 等待 N 秒确认结束
3. 识别完成 → 显示识别文本
4. 调用 API → AI 回复
5. AI 语音回复 → 同时显示文字
6. 重复步骤 1
```

### F3. 打字输入
**优先级:** P1 (重要)

**描述:** 支持传统文字输入方式

**需求细则:**
- [ ] 文本输入框支持多行输入
- [ ] 发送按钮点击发送
- [ ] 支持键盘回车发送
- [ ] 输入时禁用语音识别（防干扰）

### F4. 语音输出 (TTS)
**优先级:** P0 (必须)

**描述:** AI 回复以语音方式播报

**需求细则:**
- [ ] 中文语音合成
- [ ] 可调节语速
- [ ] 可调节音量
- [ ] **打断功能:** 用户说话时自动停止 TTS
- [ ] **状态同步:** TTS 状态与 UI 显示一致

### F5. 聊天记录管理
**优先级:** P1 (重要)

**描述:** 管理对话历史

**需求细则:**
- [ ] 实时显示对话内容
- [ ] 区分用户/AI 消息样式
- [ ] 消息持久化存储（App 重启后保留）
- [ ] 支持清空聊天记录
- [ ] 消息滚动和定位

### F6. 检查更新
**优先级:** P2 (普通)

**描述:** 自动检测新版本

**需求细则:**
- [ ] 手动检查更新（设置页面）
- [ ] 自动检查更新（启动时）
- [ ] 版本比较逻辑
- [ ] 更新日志显示
- [ ] 跳转下载页面
- [ ] 支持 GitHub Releases

---

## 🔧 非功能性需求

### NF1. 安全性
**优先级:** P0

| 要求 | 说明 |
|------|------|
| API Key 加密存储 | 使用 flutter_secure_storage 而非明文存储 |
| 网络传输安全 | 仅支持 HTTPS |
| 无日志泄露 | release 模式不输出敏感信息 |

### NF2. 性能
**优先级:** P1

| 要求 | 说明 |
|------|------|
| 启动时间 | < 3 秒 |
| 语音识别延迟 | < 500ms |
| API 响应处理 | 不阻塞 UI |
| 内存占用 | < 100MB |

### NF3. 兼容性
**优先级:** P1

| 要求 | 说明 |
|------|------|
| Android 版本 | 5.0 (API 21) 以上 |
| 屏幕尺寸 | 手机 + 平板 |
| 深色模式 | 系统级深色模式支持 |
| 网络状态 | 无网络时提示 |

### NF4. 用户体验
**优先级:** P1

| 要求 | 说明 |
|------|------|
| 状态反馈 | 每个操作有明确反馈 |
| 错误提示 | 友好的错误信息 |
| Loading 状态 | 异步操作显示加载动画 |
| 语音状态 | 清晰的状态图标和颜色 |

---

## 🏗️ 技术架构

### 推荐架构
```
lib/
├── main.dart                 # 应用入口
├── config/                   # 配置相关
│   ├── config_page.dart      # 配置页面
│   └── config_model.dart     # 配置数据模型
├── services/                 # 服务层
│   ├── api_service.dart      # API 调用服务
│   ├── speech_service.dart   # 语音识别服务
│   ├── tts_service.dart      # 语音合成服务
│   ├── storage_service.dart  # 本地存储服务
│   └── update_service.dart   # 更新检查服务
├── providers/                # 状态管理
│   ├── chat_provider.dart    # 聊天状态
│   └── config_provider.dart  # 配置状态
├── models/                   # 数据模型
│   ├── message.dart          # 消息模型
│   └── config.dart           # 配置模型
├── ui/                       # UI 组件
│   ├── chat/                 # 聊天页面
│   │   ├── chat_page.dart
│   │   ├── message_widget.dart
│   │   └── input_widget.dart
│   └── components/           # 通用组件
│       ├── state_indicator.dart
│       └── loading_overlay.dart
└── utils/                    # 工具类
    ├── logger.dart
    └── validators.dart
```

### 推荐依赖

| 依赖包 | 版本 | 用途 |
|--------|------|------|
| flutter | 3.13.9 | 框架 |
| provider | ^6.0.5 | 状态管理 |
| http | ^1.1.0 | 网络请求 |
| speech_to_text | ^6.6.0 | 语音识别 |
| flutter_tts | ^3.8.5 | 语音合成 |
| flutter_secure_storage | ^9.0.0 | 加密存储 |
| shared_preferences | ^2.2.2 | 轻量存储 |
| connectivity_plus | ^5.0.2 | 网络状态 |
| package_info_plus | ^4.2.0 | 版本信息 |
| url_launcher | ^6.2.2 | 打开链接 |
| uuid | ^4.0.0 | 唯一ID |

---

## 📝 开发计划

### Phase 1: 基础架构 (1-2 天)
- [ ] 搭建项目结构
- [ ] 配置依赖包
- [ ] 实现状态管理 (Provider)
- [ ] 实现配置服务

### Phase 2: 核心对话 (2-3 天)
- [ ] 实现 VAD 语音活动检测
- [ ] 重构语音识别服务
- [ ] 实现持续对话逻辑
- [ ] 实现 TTS 打断功能

### Phase 3: 功能完善 (1-2 天)
- [ ] 消息持久化
- [ ] 网络状态检测
- [ ] 错误重试机制

### Phase 4: UI/UX 优化 (1 天)
- [ ] 深色模式支持
- [ ] 状态指示器优化
- [ ] Loading 动画
- [ ] 错误提示优化

### Phase 5: 测试与发布 (1 天)
- [ ] 功能测试
- [ ] 性能测试
- [ ] 更新 CI/CD
- [ ] 发布新版本

---

## 🐛 当前已知问题 (需修复)

| 序号 | 问题 | 严重程度 | 修复方案 |
|------|------|----------|----------|
| 1 | 语音是"按键说话"模式 | 高 | 实现 VAD 自动检测 |
| 2 | API Key 明文存储 | 高 | 使用 flutter_secure_storage |
| 3 | 消息无持久化 | 中 | 使用 Hive/SQLite |
| 4 | 无网络状态检测 | 中 | 使用 connectivity_plus |
| 5 | 无 TTS 打断 | 中 | 实现 TTS.stop() |
| 6 | 代码未模块化 | 低 | 按架构拆分文件 |
| 7 | 无深色模式 | 低 | ThemeData 配置 |

---

## 📦 版本规划

### v2.0.0 (当前开发)
- ✅ 全新架构
- ✅ 持续对话模式
- ✅ 加密存储
- ✅ 消息持久化
- ⏳ 深色模式

### v2.1.0 (后续)
- [ ] 多语言支持
- [ ] 快捷回复
- [ ] 对话导出

### v3.0.0 (未来)
- [ ] 支持多模型切换
- [ ] 语音克隆
- [ ] 自定义提示词

---

*文档版本: 2.0.0*
*最后更新: 2026-01-21*
